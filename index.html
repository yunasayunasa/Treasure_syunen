// src/handlers/mesh_show.js (Phaser 3.60 完全互換版)

export function handleMeshShow(manager, params) {
    const name = params.name;
    if (!name) { console.warn('[mesh_show] nameは必須です。'); return Promise.resolve(); }
    
    const storage = params.storage;
    if (!storage) { console.warn('[mesh_show] storageは必須です。'); return Promise.resolve(); }
    const x = params.x !== undefined ? Number(params.x) : manager.scene.scale.width / 2;
    const y = params.y !== undefined ? Number(params.y) : manager.scene.scale.height / 2;
    const time = Number(params.time) || 0;

    if (manager.scene.characters[name]) {
        manager.scene.characters[name].destroy();
    }

    const texture = manager.scene.textures.get(storage);
    if (!texture || texture.key === '__MISSING') {
        console.error(`[mesh_show] テクスチャ[${storage}]が見つかりません。`);
        return Promise.resolve();
    }
    const frame = texture.get();
    const width = frame.width;
    const height = frame.height;

    // --- Phaser 3.60でMeshを生成する確実な方法 ---
    const vertices = [ -width / 2, -height / 2, width / 2, -height / 2, -width / 2, height / 2, width / 2, height / 2 ];
    const uvs = [ 0, 0, 1, 0, 0, 1, 1, 1 ];
    const faces = [ 0, 2, 3, 0, 3, 1 ];
    const colors = [ 0xffffff, 0xffffff, 0xffffff, 0xffffff ];
    const alphas = [ 1, 1, 1, 1 ];

    // 1. クラスから直接インスタンス化
    const chara = new Phaser.GameObjects.Mesh(manager.scene, x, y, storage, null, vertices, uvs, faces, colors, alphas);
    
    // 2. シーンに手動で追加
    manager.scene.add.existing(chara);
    // --- ここまで ---

    // グリッド分割
    chara.setGrid(2, 2);
    
    manager.layers.character.add(chara);
    chara.setAlpha(0);
    manager.scene.characters[name] = chara;

    return new Promise(resolve => {
        if (time > 0) {
            manager.scene.tweens.add({ targets: chara, alpha: 1, duration: time, ease: 'Linear', onComplete: resolve });
        } else {
            chara.setAlpha(1);
            resolve();
        }
    });
}
